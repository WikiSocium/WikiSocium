extends BaseWidget

block widget
  - if (widget.label != undefined)
    label
      - if (widget.label.name == undefined)
        | !{widget.label}
      - else
        | !{widget.label.name}
  .document_container
    .span7.document_textarea
      .document_view(id="documentView_"+widget.doc_name)
    .span5
      .document_organizations.gray-rounded-corners.gray-rounded-block2(id="documentOrganizationsView_"+widget.doc_name)
      div
        span#rtf_btn.btn.btn-primary.documentButtons Скачать копию
        span#print_btn.btn.print_btn Распечатать

  // Organization record template
  script#documentOrganizationTemplate(type="text/x-jquery-tmpl")
    div.documentOrganizationsRecord
      div.documentOrganizationsRecordTitle
        span ${Organization_Name} (ответа ждать ${Waiting_time} дней)
      div.documentOrganizationTimer(org_title="${Organization_Id}", org_time="${Waiting_time}")
      div.documentOrganizationsRecordDescription
        div(style="position:relative;") ${Description}

  // Print- and save- buttons behaviour
  script(type="text/javascript")  
    function checkValue(value)
    {
      if(typeof(value) != "undefined")
        return value;
      else
        return "No value was found";    
    }  
    $("#rtf_btn").click(function()
    {
        var html=$("#documentView_#{widget.doc_name}").html();        
        // Отправляем html на сервер, получаем rtf в ответ.
        $.post('/OpenDocument', '&text=' + encodeURIComponent(html), function(res) {
                //- Добавляем невидимый фрейм для скачивания документа без редиректа.
                $("body").append("<iframe src='" + "./../" + res + "' style='display: none;' ></iframe>");
            });
    });    
    $("#print_btn").click(function()
    {
        var modal_title = "Документ!";
        var html=$("#documentView_#{widget.doc_name}").html();
        var printWin = window.open("","Документ");
        printWin.document.open();
        printWin.document.write(html);
        printWin.document.close();
    });

  - if (typeof(widget.user_organizations) != "undefined")
    script
      var user_organizations = !{JSON.stringify(widget.user_organizations)};
  - else
    script
      var user_organizations = []; 

  script    
    step#{step_id}FieldsList['!{widget.id}'] = new DocumentViewWidget(!{JSON.stringify(value)});
    ( function()
      {
        var #{widget.doc_name}_initDocumentWidgetFunction = function()
        {
          var times = !{JSON.stringify(widget.organizations_times)};
          RegionalizedData.GetDataFromDBWithRegion (
              GetUserRegion(),
              'organizations',
              !{JSON.stringify(widget.organizations)},
              function(fetchedData) {
                $("#documentOrganizationsView_#{widget.doc_name}").hide();
                $("#documentOrganizationsView_#{widget.doc_name}").children().remove();
                //
                for (var yauo in user_organizations) {
                  var yauo_obj = {
                    short_description : "user organization",
                    description: {}
                  };
                  //   
                  var allWidgetsDataArgument = CollectFormData();              
                  if ( typeof(user_organizations[yauo].description) != "undefined" ) {
                    for ( var d in user_organizations[yauo].description ) {
                      if ( typeof(allWidgetsDataArgument[user_organizations[yauo].description[d]]) != "undefined" ) {       
                        yauo_obj.description[d] = allWidgetsDataArgument[user_organizations[yauo].description[d]];
                      }
                    }
                  }
                  //
                  if(typeof(allWidgetsDataArgument[user_organizations[yauo].widget_id]) != "undefined") {
                    yauo_obj.title = allWidgetsDataArgument[user_organizations[yauo].widget_id];
                  }
                  //
                  fetchedData.push([[yauo_obj]]);
                  times.push(user_organizations[yauo].wait_time);
                }
                //
                //
                //
                if(fetchedData.length > 0)
                  $("#documentOrganizationsView_#{widget.doc_name}").show();
                else
                  GenerateDocument_#{widget.doc_name}();
                for (var k = 0; k < fetchedData.length; k++)
                {
                  var data = fetchedData[k];
                  for (var i = 0; i < data.length; i++)
                  {    
                      for (var j = 0; j < data[i].length; j++)
                      {
                          var aData = data[i][j];
                          var title = data[i][j]["title"];
                          //
                          var org_data = {
                              "Organization_Name": title,
                              "Organization_Id": escape(title),
                              "Waiting_time": times[k]
                          };
                          for(var key in data[i][j]["description"]) {
                            if (typeof(data[i][j]["description"][key]) == "object") {
                              for(var key2 in data[i][j]["description"][key]) {
                                  org_data["Description"] = key2 + " = " + data[i][j]["description"][key][key2]
                              }
                            } else {
                              if(data[i][j]["description"][key] != "") {
                                if(key == "web") {
                                  org_data["Description"] = "<a href='" + data[i][j]["description"][key] + "' style='position:relative;'>" + data[i][j]["description"][key] + "</a>";
                                } else {
                                  org_data["Description"] = key + " = " + data[i][j]["description"][key];
                                }
                              }
                            }
                          }
                          //
                          if(k == 0 && i == 0 && j == 0) {
                            GenerateDocument_#{widget.doc_name}(data[i][j]);
                          }
                          //
                          var rec = $("#documentOrganizationTemplate").tmpl(org_data);
                          $(rec).click(
                            ( function(aData) {
                              return function(event) {
                                GenerateDocument_#{widget.doc_name}(aData);  
                              };
                            } )(aData)
                          );
                          //                          
                          var savedValue = step#{step_id}FieldsList['!{widget.id}'].getValue();
                          if ( typeof(savedValue[escape(title)]) != "undefined" ) {
                            rec.find('.documentOrganizationTimer').addClass("timer-activated");
                          }
                          $("#documentOrganizationsView_#{widget.doc_name}").append(rec);
                      }
                  }
                }
                //
                $(".documentOrganizationTimer").click(function() {
                  if ($(this).hasClass("timer-activated")) {
                    $(this).removeClass("timer-activated");
                    delete step#{step_id}FieldsList['!{widget.id}'].timersValues[$(this).attr("org_title")];
                  } else {
                    $(this).addClass("timer-activated");
                    step#{step_id}FieldsList['!{widget.id}'].timersValues[$(this).attr("org_title")] = {
                      beginDate: new Date(),
                      interval: $(this).attr("org_time")
                    };
                    console.log( step#{step_id}FieldsList['!{widget.id}'].timersValues );
                    console.log( JSON.stringify ( step#{step_id}FieldsList['!{widget.id}'].timersValues ) );
                  }
                });
                //
                // If there is only one organization, keep it shown
                if ( $(".documentOrganizationsRecordDescription").length == 1 ) {
                  $(".documentOrganizationsRecordDescription").show('slow');
                }
                $(".documentOrganizationsRecord").click(function() {
                  $(".documentOrganizationsRecord").children(".documentOrganizationsRecordDescription").hide('slow');
                  $(this).children(".documentOrganizationsRecordDescription").show('slow');            
                });
              }
          );
        };
        //
        $("#documentView_#{widget.doc_name}").closest(".step").watch("display", function() {     
          // Only regenerate document, organizations should be leaved unchanged
          // GenerateDocument_#{widget.doc_name}();
          
          // No, organizations list may change too
          #{widget.doc_name}_initDocumentWidgetFunction();
        }, 100, "");
        //
        if ( $("#documentView_#{widget.doc_name}").closest(".step").is(":visible") ) {
          setTimeout (function() {
            #{widget.doc_name}_initDocumentWidgetFunction();
          }, 1000); // [TODO] #(document).ready() doesn't work properly
        }
      }
    )();